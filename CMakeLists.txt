# Set up cmake
cmake_minimum_required (VERSION 2.6)
project (ClockProject CXX C)
set (CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} ${CMAKE_CURRENT_SOURCE_DIR})

# Check platform
if(NOT UNIX)
    message( FATAL_ERROR "This project can only compile in Unix systems" )
endif()

# track library version
set(CLOCK_MAJOR_VERSION 4)
set(CLOCK_MINOR_VERSION 1)
set(CLOCK_PATCH_VERSION 0)
set(CLOCK_VERSION
  ${CLOCK_MAJOR_VERSION}.${CLOCK_MINOR_VERSION}.${CLOCK_PATCH_VERSION})

# Set ouput paths
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_SOURCE_DIR}/bin)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_SOURCE_DIR}/lib)

# Make relative paths absolute (needed later on)
foreach(p LIB BIN INCLUDE CMAKE)
  set(var INSTALL_${p}_DIR)
  if(NOT IS_ABSOLUTE "${${var}}")
    set(${var} "${CMAKE_INSTALL_PREFIX}/${${var}}")
  endif()
endforeach()

# set up include-directories
include_directories(
  "${PROJECT_SOURCE_DIR}/src"  # Add the root of the project so we can include headers as config.h
  "${PROJECT_BINARY_DIR}/src"
  "${PROJECT_BINARY_DIR}") # Add the building directory so the header files autogenerated are also available

# set up install directories
set(INSTALL_BIN_DIR "${CMAKE_INSTALL_PREFIX}/bin")
set(INSTALL_LIB_DIR "${CMAKE_INSTALL_PREFIX}/lib")
set(INSTALL_INCLUDE_DIR "${CMAKE_INSTALL_PREFIX}/include/clock")
set(INSTALL_CMAKE_DIR "${CMAKE_INSTALL_PREFIX}/share/clock")
set(INSTALL_QTPLUGINS_DIR "/usr/lib/qt4/plugins/designer/")

# Find LIbrary
FIND_PACKAGE(Qt 4 REQUIRED)
set (QT_USE_QTDESIGNER TRUE)
set (QT_USE_QTGUI TRUE)
INCLUDE(${QT_USE_FILE})
ADD_DEFINITIONS(${QT_DEFINITIONS})

# Add code
add_subdirectory(src)

# Generate confi files for cmake
# ===============================

# Add all targets to the build-tree export set
export(TARGETS clock analogclock digitalclock
  FILE "${PROJECT_BINARY_DIR}/ClockTargets.cmake")

# Export the package for use from the build-tree
# (this registers the build-tree with a global CMake-registry)
export(PACKAGE Clock)

# Create the ClockConfig.cmake and ClockConfigVersion files
file(RELATIVE_PATH REL_INCLUDE_DIR "${INSTALL_CMAKE_DIR}"
   "${INSTALL_INCLUDE_DIR}")
# ... for the build tree
set(CONF_INCLUDE_DIRS "${PROJECT_SOURCE_DIR}" "${PROJECT_BINARY_DIR}")
configure_file(ClockConfig.cmake.in
  "${PROJECT_BINARY_DIR}/ClockConfig.cmake" @ONLY)
# ... for the install tree
set(CONF_INCLUDE_DIRS "\${Clock_CMAKE_DIR}/${REL_INCLUDE_DIR}")
configure_file(ClockConfig.cmake.in
  "${PROJECT_BINARY_DIR}${CMAKE_FILES_DIRECTORY}/ClockConfig.cmake" @ONLY)
# ... for both
configure_file(ClockConfigVersion.cmake.in
  "${PROJECT_BINARY_DIR}/ClockConfigVersion.cmake" @ONLY)

# Install the ClockConfig.cmake and ClockConfigVersion.cmake
install(FILES
  "${PROJECT_BINARY_DIR}${CMAKE_FILES_DIRECTORY}/ClockConfig.cmake"
  "${PROJECT_BINARY_DIR}/ClockConfigVersion.cmake"
  DESTINATION "${INSTALL_CMAKE_DIR}" COMPONENT dev)

# Install the export set for use with the install-tree
install(EXPORT ClockTargets DESTINATION
  "${INSTALL_CMAKE_DIR}" COMPONENT dev)

# Unisntall
add_custom_target(uninstall
    COMMAND xargs --verbose rm < ${CMAKE_SOURCE_DIR}/build/install_manifest.txt
)
